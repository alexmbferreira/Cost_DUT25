<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BOM Viewer (Interactive)</title>
<style>
  :root {
    /* Base */
    --bg: #f7fafc;
    --ink: #1e293b;
    --muted: #64748b;

    /* Hierarchy */
    --car-bg: #fef3c7;         /* light amber for car root */
    --system-bg: #ffedd5;      /* light orange for systems */
    --assembly-bg: #dbeafe;    /* light blue for assemblies */
    --subasm-bg: #eff6ff;      /* even lighter blue for subassemblies */
    --part-bg: #ffffff;        /* white for parts */

    /* Surfaces */
    --card: #ffffff;
    --border: #e2e8f0;
    --row: #f8fafc;
    --row-alt: #f1f5f9;

    /* Table header / toolbar */
    --table-header-bg: #e2e8f0;
    --table-header-ink: #0f172a;
    --toolbar-bg: #f1f5f9;
    --toolbar-border: #e2e8f0;

    /* Pills / chips */
    --pill-bg: #e0f2fe;
    --pill-ink: #0c4a6e;
    --pill-border: #bae6fd;

    /* chips by level */
    --ok-bg:#ecfdf5;   --ok-ink:#065f46;   --ok-border:#a7f3d0;
    --info-bg:#eff6ff; --info-ink:#1e40af; --info-border:#bfdbfe;
    --warn-bg:#fffbeb; --warn-ink:#92400e; --warn-border:#fde68a;
    --err-bg:#fef2f2;  --err-ink:#991b1b;  --err-border:#fecaca;

    --link: #2563eb;
    --link-hover: #1d4ed8;
    --dashed: #cbd5e1;
  }

  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  a { color: var(--link); text-decoration: none; }
  a:hover { color: var(--link-hover); text-decoration: underline; }

  .wrap { max-width: 1800px; margin: 24px auto; padding: 0 16px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 12px; }
  header h1 { font-size: 22px; margin:0; letter-spacing:.2px; }
  header .file { color: var(--muted); font-size: 12px; }

  .toolbar {
    display:grid; grid-template-columns: 1fr auto auto auto; gap:10px; align-items:center;
    background: var(--toolbar-bg);
    padding: 12px; border: 1px solid var(--toolbar-border); border-radius: 12px;
    margin-bottom: 12px;
  }

  .searchbox { display:flex; gap:8px; align-items:center; background:#fff; border:1px solid var(--border);
    border-radius:10px; padding:6px 10px; }
  .searchbox input { flex:1; background:transparent; color:var(--ink); border:none; outline:none; font-size:14px; }
  .searchbox .kbd { font-size:11px; color:var(--muted); border:1px solid var(--border); padding:1px 6px; border-radius:6px; }

  .btn {
    padding:8px 10px; border:1px solid var(--border); background:#fff; color:var(--ink);
    border-radius:10px; cursor:pointer; font-size: 13px;
  }
  .btn:hover { background:#f8fafc; }
  .btn.ghost { background:transparent; }

  .toggle-wrap { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; }

  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
  .top-pad { height: 4px; background: var(--card); position: sticky; top: 0; z-index:3; }

  table { width:100%; border-collapse: collapse; }
  thead th {
    text-align:left; font-weight:600; color: var(--table-header-ink); padding:10px 12px; font-size:12px;
    background: var(--table-header-bg);
    position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border);
  }
  tbody td { padding:10px 12px; font-size: 12.5px; vertical-align: top; border-bottom:1px solid var(--border); }

  /* Hierarchy rows */
  .car     { background: var(--car-bg);     color:var(--ink); font-weight:700; }
  .section { background: var(--system-bg);  color:var(--ink); font-weight:700; }
  .assembly { background: var(--assembly-bg); color:var(--ink); }
  .subasm  { background: var(--subasm-bg); color:var(--ink); }

  .section td, .car td { padding:10px 12px; font-size:13px; }

/* keep every part row white, no zebra */
.part-row { background: var(--part-bg) !important; }
.part-row:nth-child(odd) { background: var(--part-bg) !important; }

  .subrow { background: var(--row); }
  .subrow td { border-bottom:1px dashed var(--dashed); }

  .badge {
    display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px;
    background: var(--pill-bg); font-size: 11px; border:1px solid var(--pill-border); color: var(--pill-ink);
  }
  .muted { color: var(--muted); }
  .tiny { font-size: 11px; margin-top: 4px; color: var(--muted); line-height: 1.25; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .name { font-weight: 700; white-space: normal; }
  .desc { white-space: normal; }
  .desc .meta { margin-top:4px; font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
  .desc .meta .dot::before { content:"‚Ä¢ "; margin:0 2px 0 0; color:var(--muted); }

  .row-actions { display:flex; gap:6px; align-items:center; }
  .icon-btn { background:#fff; border:1px solid var(--border); color:var(--ink); border-radius:8px; padding:4px 8px; cursor:pointer; font-size:12px; }
  .icon-btn:hover { background:#f8fafc; }

  .chips { display:flex; flex-wrap: wrap; gap:4px; }
  .chip {
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid var(--pill-border);
    background:#fff; color:var(--ink);
    border-radius:999px; padding:2px 8px; font-size:11px; white-space:nowrap;
  }
  .chip[data-level="ok"]   { background:var(--ok-bg);   color:var(--ok-ink);   border-color:var(--ok-border); }
  .chip[data-level="info"] { background:var(--info-bg); color:var(--info-ink); border-color:var(--info-border); }
  .chip[data-level="warn"] { background:var(--warn-bg); color:var(--warn-ink); border-color:var(--warn-border); }
  .chip[data-level="err"]  { background:var(--err-bg);  color:var(--err-ink);  border-color:var(--err-border); }

  .hidden { display:none !important; }
  .lock-badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--muted);
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>BOM Viewer</h1>
        <span class="file" id="fileLabel">DUT25_Prelim_BOM_with_subparts.json</span>
        <span id="lockBadge" class="lock-badge">mode: plain</span>
      </div>
      <div class="row-actions">
        <button id="legendBtn" class="btn ghost">Help</button>
      </div>
    </header>

    <div class="toolbar">
      <!-- Search -->
      <div class="searchbox">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z" stroke="#64748b" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="searchInput" placeholder="Search parts, IDs, materials, comments‚Ä¶" />
        <span class="kbd">‚åò/</span>
      </div>

      <!-- Actions -->
      <div class="toolbar-right" style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="collapseProc">Collapse subparts</button>
        <button class="btn" id="collapseAll">Collapse everything</button>
        <button class="btn" id="expandAll">Expand all</button>
        <label class="toggle-wrap" title="Hide OK/Info chips; show only Warning/Error chips">
          <input type="checkbox" id="onlyWarnErr" />
          Show only warnings & errors
        </label>
      </div>

      <!-- Loader -->
      <div class="toolbar-right">
        <input id="jsonPath" type="text" class="btn" value="DUT25_Prelim_BOM_with_subparts.json" />
        <button class="btn" id="loadBtn">Load JSON</button>
        <button class="btn" id="reloadBtn">Reload</button>
      </div>
    </div>

    <div class="card">
      <div class="top-pad"></div>
      <table id="bomTable">
        <thead>
          <tr>
            <th style="width:18%">Name</th>
            <th style="width:34%">Description</th>
            <th style="width:7%">M/B</th>
            <th style="width:9%">Mass (g)</th>
            <th style="width:16%">Emissions</th>
            <th style="width:12%">Qty √ó Unit</th>
            <th style="width:8%">ID</th>
            <th style="width:6%">Exceptions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Help Drawer -->
  <div class="legend" id="legend" style="display:none">
    <header>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>How collapsing works</strong>
        <button id="legendClose" class="btn ghost">Close</button>
      </div>
    </header>
    <div class="body" id="legendBody">
      <ul>
        <li>Car/System/Assembly/Sub-assembly rows have a ‚ñæ caret that collapses their whole block.</li>
        <li>Part rows have a ‚ñæ caret that collapses only their subparts (process/material/fastener).</li>
        <li>‚ÄúCollapse subparts‚Äù hides all subrows under every part, without hiding headers.</li>
        <li>Use the checkbox to show only <b>Warnings/Errors</b> exception chips.</li>
      </ul>
    </div>
  </div>

<script>
/* ===================== Utilities ===================== */
const parseDecimal = (s) => {
  if (s === null || s === undefined) return null;
  if (typeof s === 'number') return s;
  const ss = String(s).trim();
  if (!ss || ss.toLowerCase() === 'nan') return null;
  const v = Number(ss.replace(',', '.'));
  return Number.isFinite(v) ? v : null;
};
const allZero = (val) => {
  const v = parseDecimal(val);
  return v !== null && v === 0;
};
const fmtE = (kg, nd=3) => {
  const v = parseDecimal(kg);
  return v === null || allZero(v) ? "Value Not Calculated or Null" : `${v.toFixed(nd)} kgCO2e`;
};
const fmtMass = (kg, nd=3) => {
  const v = parseDecimal(kg);
  return v === null ? "Value Not Calculated or Null" : `${v.toFixed(nd)} kg`;
};
const kgToGrams = (kgVal) => {
  const v = parseDecimal(kgVal);
  return v === null || allZero(v) ? "Value Not Calculated or Null" : (v * 1000).toFixed(3) + " g";
};
const qpStr = (q, p) => {
  const qn = parseDecimal(q);
  const pn = parseDecimal(p);
  if (qn === null || pn === null) return "Value Not Calculated or Null";
  const tot = (qn * pn).toFixed(2);
  return `${qn} √ó ${pn} = ${tot}‚Ç¨`;
};
const qpEmiss = (q, unitKg) => {
  const qn = parseDecimal(q);
  const en = parseDecimal(unitKg);
  if (qn === null || en === null) return "Value Not Calculated or Null";
  const tot = (qn * en).toFixed(3);
  return `${qn} √ó ${en.toFixed(3)} = ${tot} kgCO2e`;
};
const firstChildField = (obj, field) => {
  for (const [k, v] of Object.entries(obj || {})) {
    if (v && typeof v === 'object' && 'type' in v) {
      const val = v[field];
      if (val !== undefined && val !== null && String(val).trim() !== '') {
        return String(val);
      }
    }
  }
  return '';
};
const materialShort = (m) => {
  if (!m) return '';
  const s = String(m);
  return s.includes('|') ? s.split('|')[0].trim() : s.trim();
};
const isCarNode = (obj) => {
  if (!obj || typeof obj !== 'object') return false;
  const hasTotals = ('Total price' in obj) || ('Total emitions' in obj);
  const hasSystems = Object.values(obj).some(v => v && typeof v === 'object' && v.type === 'system');
  return hasTotals || hasSystems;
};

/* ===================== Exception taxonomy ===================== */
const EXC_META = {
  "CEEFMatched": "ok",
  "MatchedProcess": "ok",
  "MatchedMaterial": "ok",
  "MatchedMaterialMassBased": "ok",

  "SingleCEEFItem": "info",
  "UsedLaborType=2": "info",
  "UsedLaborType=3": "info",
  "Process": "info",
  "Material": "info",
  "Fastener": "info",
  "MassParsedKG": "info",
  "BoughtPart": "info",

  "NoCEEFSubType": "warn",
  "MassNotParsedKG": "warn",
  "MultipleCEEFMatches": "warn",
  "DensityAssumed=Aluminum": "warn",
  "DensityAssumed=Steel": "warn",
  "DensityAssumed=Plastics": "warn",
  "DensityAssumed=Wood": "warn",
  "DensityAssumed=3D Print": "warn",

  "ProcessPriceMissing": "err",
  "MaterialPriceMissing": "err",
  "BoughtPartNoCEEFMatch": "err"
};
const classifyExc = (tag) => EXC_META[tag] || "info";
const toArrayExc = (exc) => {
  if (!exc && exc !== "") return [];
  if (Array.isArray(exc)) return exc;
  const s = String(exc);
  const parts = s.includes('|') ? s.split('|') : s.split(',');
  return parts.map(t => t.trim()).filter(Boolean);
};
const arrToAttr = (arr) => (Array.isArray(arr) ? arr.join('|') : String(arr || ''));

/* Global toggle */
let ONLY_WARN_ERR = false;

function renderExceptionsFromAttr(attrStr){
  const all = toArrayExc(attrStr);
  if (!all.length) return `<span class="muted">‚Äî</span>`;
  const filtered = ONLY_WARN_ERR ? all.filter(t => ['warn','err'].includes(classifyExc(t))) : all;
  if (!filtered.length) return `<span class="muted">‚Äî</span>`;
  const chips = filtered.slice(0, 4).map(tag => {
    const lvl = classifyExc(tag);
    return `<span class="chip" data-level="${lvl}" title="${tag}">${tag}</span>`;
  }).join('');
  const more = filtered.length - 4;
  const moreChip = more > 0 ? `<span class="chip" data-level="info" title="${filtered.join(', ')}">+${more} more</span>` : '';
  return `<div class="chips">${chips}${moreChip}</div>`;
}
function refreshAllExceptionCells(){
  const tbody = document.getElementById('tbody');
  tbody.querySelectorAll('td[data-exc]').forEach(td => {
    td.innerHTML = renderExceptionsFromAttr(td.dataset.exc || '');
  });
}

/* ===================== Totals (used for headers) ===================== */
function sumPart(node){
  const c = parseDecimal(node.part_costs_sum) ?? 0;
  const e = parseDecimal(node.part_emissions_sum) ?? 0;
  const m = parseDecimal(node.part_mass_kg_sum) ?? 0;         // mass
  return {c,e,m};
}
function sumSubAssembly(node){
  let c = parseDecimal(node.sub_assembly_costs);
  let e = parseDecimal(node.sub_assembly_emissions);
  let m = parseDecimal(node.sub_assembly_mass_kg);
  if (c == null || e == null || m == null){
    c = 0; e = 0; m = 0;
    for (const v of Object.values(node)){
      if (v && typeof v === 'object'){
        if (v.type === 'part'){ const s = sumPart(v); c += s.c; e += s.e; m += s.m; }
        else if (v.type === 'sub_assembly'){ const s = sumSubAssembly(v); c += s.c; e += s.e; m += s.m; }
        else if (v.type === 'assembly'){ const s = sumAssembly(v); c += s.c; e += s.e; m += s.m; }
      }
    }
  }
  return {c,e,m};
}
function sumAssembly(node){
  let c = parseDecimal(node.assembly_costs);
  let e = parseDecimal(node.assembly_emissions);
  let m = parseDecimal(node.assembly_mass_kg);
  if (c == null || e == null || m == null){
    c = 0; e = 0; m = 0;
    for (const v of Object.values(node)){
      if (v && typeof v === 'object'){
        if (v.type === 'part'){ const s = sumPart(v); c += s.c; e += s.e; m += s.m; }
        else if (v.type === 'sub_assembly'){ const s = sumSubAssembly(v); c += s.c; e += s.e; m += s.m; }
      }
    }
  }
  return {c,e,m};
}
function sumSystem(node){
  // Prefer precomputed system_* from Python if present
  let c = parseDecimal(node.system_costs);
  let e = parseDecimal(node.system_emissions);
  let m = parseDecimal(node.system_mass_kg);
  if (c == null || e == null || m == null){
    c = 0; e = 0; m = 0;
    for (const v of Object.values(node)){
      if (v && typeof v === 'object'){
        if (v.type === 'assembly'){ const s = sumAssembly(v); c += s.c; e += s.e; m += s.m; }
        else if (v.type === 'sub_assembly'){ const s = sumSubAssembly(v); c += s.c; e += s.e; m += s.m; }
        else if (v.type === 'part'){ const s = sumPart(v); c += s.c; e += s.e; m += s.m; }
      }
    }
  }
  return {c,e,m};
}

/* ===================== Rendering helpers ===================== */
function rowSectionHTML(inner, cls='section', colspan=8) {
  const tr = document.createElement('tr');
  tr.className = cls;
  const td = document.createElement('td');
  td.colSpan = colspan;
  td.innerHTML = inner;
  tr.appendChild(td);
  return tr;
}
function rowHeaderWithToggle(labelHTML, rightHTML=''){
  return `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="icon-btn hdr-toggle">‚ñæ</button>
        ${labelHTML}
      </div>
      <div class="muted">${rightHTML}</div>
    </div>`;
}
function collectChildExceptions(partObj){
  const ex = [];
  for (const [k, v] of Object.entries(partObj || {})) {
    if (v && typeof v === 'object' && 'type' in v) {
      const childExc = toArrayExc(v.exception);
      if (childExc.length) ex.push(...childExc);
    }
  }
  const seen = new Set();
  return ex.filter(t => (seen.has(t) ? false : (seen.add(t), true)));
}

function rowPart({name, descHtml, mb, mass_g, emissionsHtml, emissionsNote, quant, price, costNote, id, exceptionsAttr, partKey}) {
  const tr = document.createElement('tr');
  tr.className = 'part-row';
  tr.dataset.partKey = partKey || '';
  tr.innerHTML = `
    <td class="name">
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="icon-btn toggle-part" title="Toggle details">‚ñæ</button>
        <span>${name ?? ''}</span>
      </div>
    </td>
    <td class="desc">${descHtml ?? ''}</td>
    <td>${mb ?? ''}</td>
    <td>${mass_g ?? 'Value Not Calculated or Null'}</td>
    <td>
      ${emissionsHtml ?? 'Value Not Calculated or Null'}
      ${emissionsNote ? `<div class="tiny">${emissionsNote}</div>` : ''}
    </td>
    <td>
      ${qpStr(quant, price)}
      ${costNote ? `<div class="tiny">${costNote}</div>` : ''}
    </td>
    <td class="mono">${id ?? ''}</td>
    <td class="exc-cell" data-exc=""></td>
  `;
  const excTd = tr.querySelector('.exc-cell');
  excTd.dataset.exc = exceptionsAttr || '';
  excTd.innerHTML = renderExceptionsFromAttr(exceptionsAttr || '');
  return tr;
}

function rowSub(type, name, desc, qty, unit, emissions, costNote='', emissNote='', materialNote='', kind='other', exceptionsAttr='') {
  const tr = document.createElement('tr');
  tr.className = 'subrow';
  tr.dataset.subrowKind = kind; // "process" | "material" | "fastener" | "other"
  const badge = `<span class="badge">${type}</span>`;
  const meta = materialNote ? `<div class="muted">${materialNote}</div>` : '';
  tr.innerHTML = `
    <td>${badge} ${name ?? ''}</td>
    <td>${desc ?? ''} ${meta}</td>
    <td></td>
    <td></td>
    <td>${fmtE(emissions)}${emissNote ? `<div class="tiny">${emissNote}</div>` : ''}</td>
    <td>${qpStr(qty, unit)}${costNote ? `<div class="tiny">${costNote}</div>` : ''}</td>
    <td></td>
    <td class="exc-cell" data-exc=""></td>
  `;
  const excTd = tr.querySelector('.exc-cell');
  excTd.dataset.exc = exceptionsAttr || '';
  excTd.innerHTML = renderExceptionsFromAttr(exceptionsAttr || '');
  return tr;
}

/* ===================== Data ‚Üí table ===================== */
let GLOBAL_BOM = {};
let PART_BLOCKS = [];       // [{startIndex, endIndex}]
let SUBASM_BLOCKS = [];     // "
let ASSEMBLY_BLOCKS = [];   // "
let SYSTEM_BLOCKS = [];     // "
let CAR_BLOCK = null;       // {startIndex, endIndex}

function renderBOM(bom) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  PART_BLOCKS = [];
  SUBASM_BLOCKS = [];
  ASSEMBLY_BLOCKS = [];
  SYSTEM_BLOCKS = [];
  CAR_BLOCK = null;

  for (const [carName, carObj] of Object.entries(bom)) {
    if (!(carObj && typeof carObj === 'object' && isCarNode(carObj))) continue;

    const price = carObj['Total price'];
    const emis  = carObj['Total emitions'];
    const mass  = carObj['Total mass (kg)'];
    const priceTxt = (price != null && String(price).trim() !== '') ? `${price}‚Ç¨` : 'Value Not Calculated or Null';
    const emisTxt  = (emis  != null && String(emis).trim()  !== '') ? `${parseDecimal(emis).toFixed(8)} kgCO2e` : 'Value Not Calculated or Null';
    const massTxt  = (mass  != null && String(mass).trim()  !== '') ? fmtMass(mass) : 'Value Not Calculated or Null';

    const carStart = tbody.children.length;
    tbody.appendChild(
      rowSectionHTML(
        rowHeaderWithToggle(
          `<b>Car:</b> ${carName}`,
          `Total: ${priceTxt} | Emissions: ${emisTxt} | Mass: ${massTxt}`
        ),
        'car'
      )
    );

    renderSystemsBlock(tbody, carObj);

    const carEnd = tbody.children.length - 1;
    CAR_BLOCK = { startIndex: carStart, endIndex: carEnd };
  }

  wireToggles();

  // initialize expanded state
  if (CAR_BLOCK) setHeaderCollapsed(CAR_BLOCK, false);
  SYSTEM_BLOCKS.forEach(b => setHeaderCollapsed(b, false));
  ASSEMBLY_BLOCKS.forEach(b => setHeaderCollapsed(b, false));
  SUBASM_BLOCKS.forEach(b => setHeaderCollapsed(b, false));
  PART_BLOCKS.forEach(b => setPartCollapsed(b, false));
}

function renderSystemsBlock(tbody, carObj) {
  for (const [sysCode, sysObj] of Object.entries(carObj)) {
    if (!(sysObj && typeof sysObj === 'object' && sysObj.type === 'system')) continue;

    const s = sumSystem(sysObj);
    const sysStart = tbody.children.length;
    tbody.appendChild(
      rowSectionHTML(
        rowHeaderWithToggle(
          `<span class="mono">${sysCode}</span>`,
          `Cost: ${ s.c.toFixed(2) } | Emiss: ${ fmtE(s.e) } | Mass: ${ fmtMass(s.m) }`
        ),
        'section'
      )
    );

    // Assemblies in system
    for (const [asmName, asmObj] of Object.entries(sysObj)) {
      if (asmName === 'type' || typeof asmObj !== 'object') continue;
      if (asmObj.type !== 'assembly') continue;

      const at = sumAssembly(asmObj);
      const asmStart = tbody.children.length;
      tbody.appendChild(
        rowSectionHTML(
          rowHeaderWithToggle(
            `<b>${asmName}</b> ${asmObj.assembly_no ? `<span class="mono">#${asmObj.assembly_no}</span>` : ''}`,
            `Cost: ${(parseDecimal(asmObj.assembly_costs) ?? at.c).toFixed(2)} | ` +
            `Emiss: ${ fmtE(parseDecimal(asmObj.assembly_emissions) ?? at.e) } | ` +
            `Mass:  ${ fmtMass(parseDecimal(asmObj.assembly_mass_kg) ?? at.m) }`
          ),
          'assembly'
        )
      );

      // direct parts
      for (const [k, v] of Object.entries(asmObj)) {
        if (v && typeof v === 'object' && v.type === 'part') {
          pushPartBlock(tbody, k, v);
        }
      }

      // sub-assemblies
      for (const [subName, subObj] of Object.entries(asmObj)) {
        if (!(subObj && typeof subObj === 'object' && subObj.type === 'sub_assembly')) continue;

        const st = sumSubAssembly(subObj);
        const subStart = tbody.children.length;
        tbody.appendChild(
          rowSectionHTML(
            rowHeaderWithToggle(
              `<b>${asmName}</b> ‚áí ${subName}`,
              `Cost: ${(parseDecimal(subObj.sub_assembly_costs) ?? st.c).toFixed(2)} | ` +
              `Emiss: ${ fmtE(parseDecimal(subObj.sub_assembly_emissions) ?? st.e) } | ` +
              `Mass:  ${ fmtMass(parseDecimal(subObj.sub_assembly_mass_kg) ?? st.m) }`
            ),
            'subasm'
          )
        );

        for (const [pname, pobj] of Object.entries(subObj)) {
          if (pobj && typeof pobj === 'object' && pobj.type === 'part') {
            pushPartBlock(tbody, pname, pobj);
          }
        }

        const subEnd = tbody.children.length - 1;
        SUBASM_BLOCKS.push({ startIndex: subStart, endIndex: subEnd });
      }

      const asmEnd = tbody.children.length - 1;
      ASSEMBLY_BLOCKS.push({ startIndex: asmStart, endIndex: asmEnd });
    }

    const sysEnd = tbody.children.length - 1;
    SYSTEM_BLOCKS.push({ startIndex: sysStart, endIndex: sysEnd });
  }
}

function pushPartBlock(tbody, partName, partObj) {
  const startIndex = tbody.children.length;

  const ovr = partObj.Subpart_process_overview || {};
  const mass_g = kgToGrams(ovr.mass);
  const q = parseDecimal(partObj.part_quantity) ?? 1;

  const unitPrice = parseDecimal(partObj.part_costs) ?? parseDecimal(partObj.part_costs_sum);
  const unitEmiss = parseDecimal(partObj.part_emissions) ?? parseDecimal(partObj.part_emissions_sum);
  const emissionsHtml = unitEmiss !== null ? qpEmiss(q, unitEmiss) : "Value Not Calculated or Null";

  const costNote = (ovr.material && String(ovr.material).trim() !== '') ? `Cost comment: ${ovr.material}` : '';
  const emissionsNote = firstChildField(partObj, 'comments_emissions')
    ? `Carbon comment: ${firstChildField(partObj, 'comments_emissions')}`
    : '';

  const descTop = (partObj.part_comments || '').trim();
  const mat = materialShort(ovr.material);
  const complexity = parseDecimal(ovr.complexity);
  const procList = Array.isArray(ovr.process) ? ovr.process : [];
  const metaBits = [];
  if (mat) metaBits.push(`<span class="dot">Material: ${mat}</span>`);
  if (complexity !== null) metaBits.push(`<span class="dot">Complexity: ${complexity}</span>`);
  if (procList.length) metaBits.push(`<span class="dot">Process: ${procList.map(p=>`<span class="badge">${p}</span>`).join(' ')}</span>`);
  const descHtml = `${descTop}${metaBits.length ? `<div class="meta">${metaBits.join('')}</div>` : ''}`;

  // exceptions for part (own or aggregated from children)
  const partOwn = toArrayExc(partObj.exception);
  const partAgg = partOwn.length ? partOwn : collectChildExceptions(partObj);
  const partExcAttr = arrToAttr(partAgg);

  const partRow = rowPart({
    name: partName,
    descHtml,
    mb: partObj.makebuy || '',
    mass_g,
    emissionsHtml,
    emissionsNote,
    quant: q,
    price: unitPrice,
    costNote,
    id: partObj.part_no || '',
    exceptionsAttr: partExcAttr,
    partKey: partName
  });
  tbody.appendChild(partRow);

  // sub-entries
  for (const [key, val] of Object.entries(partObj)) {
    if (!(val && typeof val === 'object' && 'type' in val)) continue;
    const t = val.type;

    const costNote = val.comments_costs ? `Cost comment: ${val.comments_costs}` : '';
    const emissNote = val.comments_emissions ? `Carbon comment: ${val.comments_emissions}` : '';
    const excAttr = arrToAttr(val.exception || '');

    if (t === 'm') {
      tbody.appendChild(
        rowSub('Bought/Material', key,
          val.comments_costs || val.subpart_comments || '',
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          costNote, emissNote, val.comments_emissions || '', 'material', excAttr
        )
      );
    } else if (t === 'p') {
      const d = val.subpart_comments || '';
      const emCom = val.comments_emissions || '';
      const meta = emCom ? `<div class="muted">${emCom}</div>` : '';
      tbody.appendChild(
        rowSub('Manufact. Process', key,
          `${d}${meta}`,
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          costNote, emissNote, '', 'process', excAttr
        )
      );
    } else if (t === 'f') {
      tbody.appendChild(
        rowSub('Fastener', key,
          val.subpart_comments || '',
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          costNote, emissNote, '', 'fastener', excAttr
        )
      );
    } else {
      tbody.appendChild(
        rowSub('Subpart', key,
          val.subpart_comments || '',
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          costNote, emissNote, '', 'other', excAttr
        )
      );
    }
  }

  const endIndex = tbody.children.length - 1;
  PART_BLOCKS.push({ startIndex, endIndex });
}

/* ===================== Visibility state (no toggling conflicts) ===================== */
function setRowsVisibility(tbody, startIndex, endIndex, visible) {
  for (let j = startIndex + 1; j <= endIndex; j++) {
    tbody.children[j].classList.toggle('hidden', !visible);
  }
}
function setCaret(btn, collapsed) { if (btn) btn.textContent = collapsed ? '‚ñ∏' : '‚ñæ'; }

function setHeaderCollapsed(block, collapsed) {
  const tbody = document.getElementById('tbody');
  const hdr = tbody.children[block.startIndex];
  hdr.dataset.collapsed = collapsed ? '1' : '0';
  setCaret(hdr.querySelector('.hdr-toggle'), collapsed);
  setRowsVisibility(tbody, block.startIndex, block.endIndex, !collapsed);
}
function getHeaderCollapsed(block) {
  const tbody = document.getElementById('tbody');
  const hdr = tbody.children[block.startIndex];
  return (hdr?.dataset.collapsed === '1');
}

function setPartCollapsed(block, collapsed) {
  const tbody = document.getElementById('tbody');
  const prow = tbody.children[block.startIndex];
  prow.dataset.collapsed = collapsed ? '1' : '0';
  setCaret(prow.querySelector('.toggle-part'), collapsed);
  for (let j = block.startIndex + 1; j <= block.endIndex; j++) {
    tbody.children[j].classList.toggle('hidden', collapsed);
  }
}
function getPartCollapsed(block) {
  const tbody = document.getElementById('tbody');
  const prow = tbody.children[block.startIndex];
  return (prow?.dataset.collapsed === '1');
}
function reapplyPartStatesWithin(range) {
  const tbody = document.getElementById('tbody');
  for (const b of PART_BLOCKS) {
    if (b.startIndex > range.startIndex && b.endIndex <= range.endIndex) {
      const collapsed = getPartCollapsed(b);
      tbody.children[b.startIndex].classList.remove('hidden'); // ensure header visible
      for (let j = b.startIndex + 1; j <= b.endIndex; j++) {
        tbody.children[j].classList.toggle('hidden', collapsed);
      }
      setCaret(tbody.children[b.startIndex].querySelector('.toggle-part'), collapsed);
    }
  }
}

/* ===================== Interactions & Collapsing ===================== */
function wireToggles() {
  const tbody = document.getElementById('tbody');

  // Header toggles (Car/System/Assembly/Sub-assembly)
  tbody.querySelectorAll('.car .hdr-toggle, .section .hdr-toggle, .assembly .hdr-toggle, .subasm .hdr-toggle')
    .forEach((btn) => {
      btn.addEventListener('click', () => {
        const row = btn.closest('tr');
        const i = Array.from(tbody.children).indexOf(row);

        const block =
          (CAR_BLOCK && CAR_BLOCK.startIndex === i ? CAR_BLOCK : null) ||
          SYSTEM_BLOCKS.find(b => b.startIndex === i) ||
          ASSEMBLY_BLOCKS.find(b => b.startIndex === i) ||
          SUBASM_BLOCKS.find(b => b.startIndex === i);
        if (!block) return;

        const collapsed = !getHeaderCollapsed(block);      // desired new state
        setHeaderCollapsed(block, collapsed);
        if (!collapsed) reapplyPartStatesWithin(block);     // restore part subpart states on expand
      });
    });

  // Part toggles (show/hide subparts only)
  tbody.querySelectorAll('.toggle-part').forEach((btn) => {
    btn.addEventListener('click', () => {
      const row = btn.closest('tr');
      const idx = Array.from(tbody.children).indexOf(row);
      const block = PART_BLOCKS.find(b => b.startIndex === idx);
      if (!block) return;
      const collapsed = !getPartCollapsed(block);          // desired new state
      setPartCollapsed(block, collapsed);
    });
  });
}

/* Top bar buttons */
document.getElementById('collapseProc').addEventListener('click', () => {
  PART_BLOCKS.forEach(b => setPartCollapsed(b, true));   // collapse all subparts
});
document.getElementById('collapseAll').addEventListener('click', () => {
  if (CAR_BLOCK) setHeaderCollapsed(CAR_BLOCK, true);
  SYSTEM_BLOCKS.forEach(b => setHeaderCollapsed(b, true));
  ASSEMBLY_BLOCKS.forEach(b => setHeaderCollapsed(b, true));
  SUBASM_BLOCKS.forEach(b => setHeaderCollapsed(b, true));
  PART_BLOCKS.forEach(b => setPartCollapsed(b, true));
});
document.getElementById('expandAll').addEventListener('click', () => {
  if (CAR_BLOCK) setHeaderCollapsed(CAR_BLOCK, false);
  SYSTEM_BLOCKS.forEach(b => setHeaderCollapsed(b, false));
  ASSEMBLY_BLOCKS.forEach(b => setHeaderCollapsed(b, false));
  SUBASM_BLOCKS.forEach(b => setHeaderCollapsed(b, false));
  PART_BLOCKS.forEach(b => setPartCollapsed(b, false));
});

/* Exceptions filter checkbox */
const onlyWarnErr = document.getElementById('onlyWarnErr');
onlyWarnErr.addEventListener('change', () => {
  ONLY_WARN_ERR = onlyWarnErr.checked;
  refreshAllExceptionCells();
});

/* Search */
const searchInput = document.getElementById('searchInput');
function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms);} }
function applySearch(){
  const q = (searchInput.value || '').toLowerCase().trim();
  const tbody = document.getElementById('tbody');
  PART_BLOCKS.forEach(({startIndex, endIndex}) => {
    let hay = '';
    const prow = tbody.children[startIndex];
    const name = prow?.querySelector('.name span')?.textContent || '';
    for (let c = 0; c < prow.children.length; c++){
      hay += ' ' + (prow.children[c].innerText || '');
    }
    const match = !q || hay.toLowerCase().includes(q) || name.toLowerCase().includes(q);
    for (let j = startIndex; j <= endIndex; j++){
      tbody.children[j].classList.toggle('hidden', !match);
    }
    if (match) {
      const collapsed = getPartCollapsed({startIndex});
      const caret = prow.querySelector('.toggle-part');
      if (caret) caret.textContent = collapsed ? '‚ñ∏' : '‚ñæ';
    }
  });
}
searchInput.addEventListener('input', debounce(applySearch, 120));
window.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === '/') { e.preventDefault(); searchInput.focus(); }
});

/* ===================== Load + Init with plain‚Üíencrypted fallback ===================== */
const PLAIN_JSON = "DUT25_Prelim_BOM_with_subparts.json";
const ENCRYPTED_JSON = "DUT25_Prelim_BOM_with_subparts_encrypted.json";
const PBKDF2_ITERS = 390000; // must match Python
const SALT_LEN = 16;
const IV_LEN = 12;
const TAG_LEN = 16;

async function tryLoadPlain(path) {
  try {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) return null;
    return await res.json();
  } catch { return null; }
}
async function loadEncrypted(path) {
  const res = await fetch(path, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Encrypted JSON not found (${res.status})`);
  const buf = await res.arrayBuffer();
  if (buf.byteLength < SALT_LEN + IV_LEN + TAG_LEN + 1) throw new Error("Encrypted blob too small");

  const salt = buf.slice(0, SALT_LEN);
  const iv   = buf.slice(SALT_LEN, SALT_LEN + IV_LEN);
  const tag  = buf.slice(buf.byteLength - TAG_LEN);
  const ct   = buf.slice(SALT_LEN + IV_LEN, buf.byteLength - TAG_LEN);

  const pwd = prompt("üîí Enter password to unlock BOM:"); if (!pwd) throw new Error("No password entered");
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pwd), { name: "PBKDF2" }, false, ["deriveKey"]);
  const key = await crypto.subtle.deriveKey(
    { name: "PBKDF2", salt: salt, iterations: PBKDF2_ITERS, hash: "SHA-256" },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["decrypt"]
  );

  const full = new Uint8Array(ct.byteLength + tag.byteLength);
  full.set(new Uint8Array(ct), 0);
  full.set(new Uint8Array(tag), new Uint8Array(ct).length);

  try {
    const plain = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, full);
    return JSON.parse(new TextDecoder().decode(plain));
  } catch { throw new Error("Decryption failed (wrong password or corrupted file)."); }
}

async function loadAndRender(path) {
  const fileLabel = document.getElementById('fileLabel');
  const lockBadge = document.getElementById('lockBadge');
  fileLabel.textContent = path;

  let bom = await tryLoadPlain(path);
  if (bom) {
    lockBadge.textContent = "mode: plain";
    GLOBAL_BOM = bom;
    renderBOM(GLOBAL_BOM);
    refreshAllExceptionCells();
    return;
  }

  try {
    bom = await loadEncrypted(ENCRYPTED_JSON);
    lockBadge.textContent = "mode: encrypted";
    fileLabel.textContent = ENCRYPTED_JSON;
    GLOBAL_BOM = bom;
    renderBOM(GLOBAL_BOM);
    refreshAllExceptionCells();
  } catch (err) {
    console.warn(err);
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = `<tr><td colspan="8" class="muted">Could not load BOM. ${err.message}</td></tr>`;
  }
}

document.getElementById('loadBtn').addEventListener('click', () => {
  const p = document.getElementById('jsonPath').value.trim() || PLAIN_JSON;
  loadAndRender(p).catch(err => alert(err.message));
});
document.getElementById('reloadBtn').addEventListener('click', () => {
  const p = document.getElementById('jsonPath').value.trim() || PLAIN_JSON;
  loadAndRender(p).catch(err => alert(err.message));
});

/* Help */
const legend = document.getElementById('legend');
document.getElementById('legendBtn').addEventListener('click', () => { legend.style.display = 'block'; });
document.getElementById('legendClose').addEventListener('click', () => { legend.style.display = 'none'; });

/* Initial load */
loadAndRender(document.getElementById('jsonPath').value).catch(err => {
  console.warn(err);
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = `<tr><td colspan="8" class="muted">Could not load JSON. Check files and serve via a local web server.</td></tr>`;
});
</script>
</body>
</html>
