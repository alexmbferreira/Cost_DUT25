<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BOM Viewer (Interactive)</title>
<style>
  :root {
    /* ===== Palette (tweak freely) ===== */
    /* Base */
    --bg: #f7fafc;
    --ink: #1e293b;
    --muted: #64748b;

    /* Hierarchy */
    --system-bg: #ffedd5;       /* light orange for systems */
    --assembly-bg: #dbeafe;     /* light blue for assemblies */
    --subasm-bg: #eff6ff;       /* even lighter blue for subassemblies */
    --part-bg: #ffffff;         /* white for parts */

    /* Accents & surfaces */
    --card: #ffffff;
    --border: #e2e8f0;
    --row: #f8fafc;
    --row-alt: #f1f5f9;

    /* Header / toolbar */
    --table-header-bg: #e2e8f0;
    --table-header-ink: #0f172a;
    --toolbar-bg: #f1f5f9;
    --toolbar-border: #e2e8f0;

    /* Tags / badges / pills */
    --pill-bg: #e0f2fe;
    --pill-ink: #0c4a6e;
    --pill-border: #bae6fd;

    /* Chips (exception pills) */
    --chip-bg: #fff7ed;
    --chip-ink: #7c2d12;
    --chip-border: #fed7aa;

    /* Chips by level */
    --ok-bg: #ecfdf5;     --ok-ink: #065f46;     --ok-border: #a7f3d0;
    --info-bg: #eff6ff;   --info-ink: #1e40af;   --info-border: #bfdbfe;
    --warn-bg: #fffbeb;   --warn-ink: #92400e;   --warn-border: #fde68a;
    --err-bg: #fef2f2;    --err-ink: #991b1b;    --err-border: #fecaca;

    /* Icon / link */
    --link: #2563eb;
    --link-hover: #1d4ed8;

    /* Tiny separators */
    --dashed: #cbd5e1;
  }

  * { box-sizing: border-box; }
  html, body { margin:0; padding:0; background:var(--bg); color:var(--ink);
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  a { color: var(--link); text-decoration: none; }
  a:hover { color: var(--link-hover); text-decoration: underline; }

  .wrap { max-width: 1800px; margin: 24px auto; padding: 0 16px; }
  header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 12px; }
  header h1 { font-size: 22px; margin:0; letter-spacing:.2px; }
  header .file { color: var(--muted); font-size: 12px; }

  .toolbar {
    display:grid; grid-template-columns: 1fr auto auto auto; gap:10px; align-items:center;
    background: var(--toolbar-bg);
    padding: 12px; border: 1px solid var(--toolbar-border); border-radius: 12px;
    margin-bottom: 12px;
  }

  .searchbox { display:flex; gap:8px; align-items:center; background:#fff; border:1px solid var(--border);
    border-radius:10px; padding:6px 10px; }
  .searchbox input { flex:1; background:transparent; color:var(--ink); border:none; outline:none; font-size:14px; }
  .searchbox .kbd { font-size:11px; color:var(--muted); border:1px solid var(--border); padding:1px 6px; border-radius:6px; }

  .filters { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .sel, .btn {
    padding:8px 10px; border:1px solid var(--border); background:#fff; color:var(--ink);
    border-radius:10px; cursor:pointer; font-size: 13px;
  }
  .btn:hover { background:#f8fafc; }
  .btn.ghost { background:transparent; }

  .toggle-wrap { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; }
  .toggle-wrap input { transform: translateY(1px); }

  .card { background:var(--card); border:1px solid var(--border); border-radius:14px; overflow:hidden; }
  .top-pad { height: 4px; background: var(--card); position: sticky; top: 0; z-index:3; }

  table { width:100%; border-collapse: collapse; }
  thead th {
    text-align:left; font-weight:600; color: var(--table-header-ink); padding:10px 12px; font-size:12px;
    background: var(--table-header-bg);
    position: sticky; top: 0; z-index: 2; border-bottom: 1px solid var(--border);
  }
  tbody td { padding:10px 12px; font-size: 12.5px; vertical-align: top; border-bottom:1px solid var(--border); }

  /* Hierarchy rows */
  .section { background: var(--system-bg); color:var(--ink); font-weight:700; }
  .section td { padding:10px 12px; font-size:13px; }
  .assembly { background: var(--assembly-bg); color:var(--ink); }
  .subasm  { background: var(--subasm-bg); color:var(--ink); }

  /* parts */
  .part-row { background: var(--part-bg); }
  .part-row:nth-child(odd) { background: var(--row-alt); }

  .subrow { background: var(--row); }
  .subrow td { border-bottom:1px dashed var(--dashed); }

  .badge {
    display:inline-flex; align-items:center; gap:6px; padding:2px 8px; border-radius:999px;
    background: var(--pill-bg); font-size: 11px; border:1px solid var(--pill-border); color:var(--pill-ink);
  }
  .muted { color: var(--muted); }
  .tiny { font-size: 11px; margin-top: 4px; color: var(--muted); line-height: 1.25; }
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  .name { font-weight: 700; white-space: normal; }
  .desc { white-space: normal; }
  .desc .meta { margin-top:4px; font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; }
  .desc .meta .dot::before { content:"• "; margin:0 2px 0 0; color:var(--muted); }

  .chips { display:flex; flex-wrap: wrap; gap:4px; }
  .chip {
    display:inline-flex; align-items:center; gap:6px;
    border:1px solid var(--chip-border); background:var(--chip-bg); color:var(--chip-ink);
    border-radius:999px; padding:2px 8px; font-size:11px; white-space:nowrap;
  }
  .chip[data-level="ok"]   { background:var(--ok-bg);   color:var(--ok-ink);   border-color:var(--ok-border); }
  .chip[data-level="info"] { background:var(--info-bg); color:var(--info-ink); border-color:var(--info-border); }
  .chip[data-level="warn"] { background:var(--warn-bg); color:var(--warn-ink); border-color:var(--warn-border); }
  .chip[data-level="err"]  { background:var(--err-bg);  color:var(--err-ink);  border-color:var(--err-border); }

  /* legend drawer */
  .legend { position: fixed; right:16px; bottom:16px; width: 380px; max-height: 70vh; overflow:auto;
    background:#fff; border:1px solid var(--border); border-radius:12px; box-shadow: 0 8px 30px rgba(2,8,23,.12); display:none; }
  .legend header { padding:10px 12px; border-bottom:1px solid var(--border); }
  .legend .body { padding:12px; font-size:12px; color:var(--ink); }
  .legend h3 { margin:0 0 6px 0; font-size:13px; }
  .legend .row { display:flex; gap:6px; align-items:center; margin-bottom:6px; }
  .legend .row .key { width:110px; color:var(--muted); }

  .row-actions { display:flex; gap:6px; align-items:center; }
  .icon-btn { background:#fff; border:1px solid var(--border); color:var(--ink); border-radius:8px; padding:4px 8px; cursor:pointer; font-size:12px; }
  .icon-btn:hover { background:#f8fafc; }

  .hidden { display:none !important; }

  /* lock badge */
  .lock-badge {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--muted);
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>BOM Viewer</h1>
        <span class="file" id="fileLabel">DUT25_Prelim_BOM_with_subparts.json</span>
        <span id="lockBadge" class="lock-badge">mode: plain</span>
      </div>
      <div class="row-actions">
        <button id="legendBtn" class="btn ghost">Exception Legend</button>
      </div>
    </header>

    <div class="toolbar">
      <!-- Search -->
      <div class="searchbox">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M21 21l-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z" stroke="#64748b" stroke-width="1.6" stroke-linecap="round"/></svg>
        <input id="searchInput" placeholder="Search parts, IDs, materials, comments, or exceptions…" />
        <span class="kbd">⌘/</span>
      </div>

      <!-- Filters -->
      <div class="filters">
        <select id="makeBuyFilter" class="sel">
          <option value="all">Make/Buy: All</option>
          <option value="m">Make only</option>
          <option value="b">Buy only</option>
        </select>

        <select id="exceptionFilter" class="sel">
          <option value="all">Exceptions: All</option>
          <option value="only">Only with exceptions</option>
          <option value="none">Only without exceptions</option>
        </select>

        <select id="exceptionTagFilter" class="sel" multiple size="1" title="Filter by specific exception tags">
          <!-- populated dynamically -->
        </select>

        <!-- NEW: show only warnings & errors -->
        <label class="toggle-wrap" title="Hide OK/Info chips; show only Warning/Error chips">
          <input type="checkbox" id="onlyWarnErr" />
          Show only warnings & errors
        </label>
      </div>

      <!-- Actions -->
      <div class="toolbar-right">
        <button class="btn" id="collapseAll">Collapse All</button>
        <button class="btn" id="expandAll">Expand All</button>
      </div>

      <!-- Loader -->
      <div class="toolbar-right">
        <input id="jsonPath" type="text" class="sel" value="DUT25_Prelim_BOM_with_subparts.json" />
        <button class="btn" id="loadBtn">Load JSON</button>
        <button class="btn" id="reloadBtn">Reload</button>
      </div>
    </div>

    <div class="card">
      <div class="top-pad"></div>
      <table id="bomTable">
        <thead>
          <tr>
            <th style="width:18%">Name</th>
            <th style="width:34%">Description</th>
            <th style="width:7%">M/B</th>
            <th style="width:9%">Mass (g)</th>
            <th style="width:16%">Emissions</th>
            <th style="width:12%">Qty × Unit</th>
            <th style="width:8%">ID</th>
            <th style="width:6%">Exceptions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Legend Drawer -->
  <div class="legend" id="legend">
    <header>
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <strong>Exception Legend</strong>
        <button id="legendClose" class="btn ghost">Close</button>
      </div>
    </header>
    <div class="body" id="legendBody">
      <!-- filled from JS -->
    </div>
  </div>

<script>
/* ===================== Utilities ===================== */
const parseDecimal = (s) => {
  if (s === null || s === undefined) return null;
  if (typeof s === 'number') return s;
  const ss = String(s).trim();
  if (!ss || ss.toLowerCase() === 'nan') return null;
  const v = Number(ss.replace(',', '.'));
  return Number.isFinite(v) ? v : null;
};
const allZero = (val) => {
  const v = parseDecimal(val);
  return v !== null && v === 0;
};
const fmtE = (kg, nd=3) => {
  const v = parseDecimal(kg);
  return v === null || allZero(v) ? "Value Not Calculated or Null" : `${v.toFixed(nd)} kgCO2e`;
};
const kgToGrams = (kgVal) => {
  const v = parseDecimal(kgVal);
  return v === null || allZero(v) ? "Value Not Calculated or Null" : (v * 1000).toFixed(3) + " g";
};
const qpStr = (q, p) => {
  const qn = parseDecimal(q);
  const pn = parseDecimal(p);
  if (qn === null || pn === null) return "Value Not Calculated or Null";
  const tot = (qn * pn).toFixed(2);
  return `${qn} × ${pn} = ${tot}€`;
};
const qpEmiss = (q, unitKg) => {
  const qn = parseDecimal(q);
  const en = parseDecimal(unitKg);
  if (qn === null || en === null) return "Value Not Calculated or Null";
  const tot = (qn * en).toFixed(3);
  return `${qn} × ${en.toFixed(3)} = ${tot} kgCO2e`;
};
const toArrayExc = (exc) => {
  if (!exc && exc !== "") return [];
  if (Array.isArray(exc)) return exc;
  const s = String(exc);
  return s.includes('|') ? s.split('|').map(t=>t.trim()).filter(Boolean)
       : s.split(',').map(t=>t.trim()).filter(Boolean);
};
const listToChips = (arr) => {
  if (!Array.isArray(arr) || !arr.length) return '';
  return arr.map(p => `<span class="chip">${p}</span>`).join(' ');
};
const firstChildField = (obj, field) => {
  for (const [k, v] of Object.entries(obj || {})) {
    if (v && typeof v === 'object' && 'type' in v) {
      const val = v[field];
      if (val !== undefined && val !== null && String(val).trim() !== '') {
        return String(val);
      }
    }
  }
  return '';
};

/* ===================== Exception taxonomy ===================== */
const EXC_META = {
  "CEEFMatched": "ok",
  "MatchedProcess": "ok",
  "MatchedMaterial": "ok",
  "MatchedMaterialMassBased": "ok",
  "SingleCEEFItem": "info",
  "UsedLaborType=2": "info",
  "UsedLaborType=3": "info",
  "Process": "info",
  "Material": "info",
  "Fastener": "info",
  "MassParsedKG": "info",
  "BoughtPart": "info",

  "NoCEEFSubType": "warn",
  "MassNotParsedKG": "warn",
  "MultipleCEEFMatches": "warn",
  "DensityAssumed=Aluminum": "warn",
  "DensityAssumed=Steel": "warn",
  "DensityAssumed=Plastics": "warn",
  "DensityAssumed=Wood": "warn",
  "DensityAssumed=3D Print": "warn",

  "ProcessPriceMissing": "err",
  "MaterialPriceMissing": "err",
  "BoughtPartNoCEEFMatch": "err"
};
const classifyExc = (tag) => EXC_META[tag] || "info";

/* ===================== Rendering ===================== */
let ONLY_WARN_ERR = false;

function rowSection(cells, cls='section') {
  const tr = document.createElement('tr');
  tr.className = cls;
  const td = document.createElement('td');
  td.colSpan = 8;
  td.innerHTML = cells;
  tr.appendChild(td);
  return tr;
}

function rowPart({name, descHtml, mb, mass_g, emissionsHtml, emissionsNote, quant, price, costNote, id, exceptions, partKey}) {
  const tr = document.createElement('tr');
  tr.className = 'part-row';
  tr.dataset.partKey = partKey || '';
  tr.innerHTML = `
    <td class="name">
      <div style="display:flex; align-items:center; gap:8px;">
        <button class="icon-btn toggle-part" title="Toggle details">▾</button>
        <span>${name ?? ''}</span>
      </div>
    </td>
    <td class="desc">${descHtml ?? ''}</td>
    <td>${mb ?? ''}</td>
    <td>${mass_g ?? 'Value Not Calculated or Null'}</td>
    <td>
      ${emissionsHtml ?? 'Value Not Calculated or Null'}
      ${emissionsNote ? `<div class="tiny">${emissionsNote}</div>` : ''}
    </td>
    <td>
      ${qpStr(quant, price)}
      ${costNote ? `<div class="tiny">${costNote}</div>` : ''}
    </td>
    <td class="mono">${id ?? ''}</td>
    <td>${renderExceptions(exceptions)}</td>
  `;
  return tr;
}

function renderExceptions(exceptions) {
  const ex = toArrayExc(exceptions);
  if (!ex.length) return `<span class="muted">—</span>`;

  const filtered = ONLY_WARN_ERR
    ? ex.filter(tag => {
        const lvl = classifyExc(tag);
        return lvl === 'warn' || lvl === 'err';
      })
    : ex;

  if (!filtered.length) return `<span class="muted">—</span>`;

  const chips = filtered.slice(0, 4).map(tag => {
    const level = classifyExc(tag);
    return `<span class="chip" data-level="${level}" title="${tag}">${tag}</span>`;
  }).join('');
  const more = filtered.length - 4;
  const moreChip = more > 0 ? `<span class="chip" data-level="info" title="${filtered.join(', ')}">+${more} more</span>` : '';
  return `<div class="chips">${chips}${moreChip}</div>`;
}

function rowSub(type, name, desc, qty, unit, emissions, exceptions, costNote='', emissNote='', materialNote='') {
  const tr = document.createElement('tr');
  tr.className = 'subrow';
  const badge = `<span class="badge">${type}</span>`;
  const meta = materialNote ? `<div class="muted">${materialNote}</div>` : '';
  tr.innerHTML = `
    <td>${badge} ${name ?? ''}</td>
    <td>${desc ?? ''} ${meta}</td>
    <td></td>
    <td></td>
    <td>
      ${fmtE(emissions)}
      ${emissNote ? `<div class="tiny">${emissNote}</div>` : ''}
    </td>
    <td>
      ${qpStr(qty, unit)}
      ${costNote ? `<div class="tiny">${costNote}</div>` : ''}
    </td>
    <td></td>
    <td>${renderExceptions(exceptions)}</td>
  `;
  return tr;
}

function materialShort(m) {
  if (!m) return '';
  const s = String(m);
  return s.includes('|') ? s.split('|')[0].trim() : s.trim();
}

/* ===================== Data → table ===================== */
let GLOBAL_BOM = {};
let FLAT_PART_ROWS = [];

function renderBOM(bom) {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  FLAT_PART_ROWS = [];

  for (const [sysCode, sysObj] of Object.entries(bom)) {
    if (!(sysObj && typeof sysObj === 'object' && sysObj.type === 'system')) continue;

    tbody.appendChild(rowSection(`<span class="mono">${sysCode}</span>`, 'section'));

    for (const [asmName, asmObj] of Object.entries(sysObj)) {
      if (asmName === 'type' || typeof asmObj !== 'object') continue;
      if (asmObj.type !== 'assembly') continue;

      const asmCost = asmObj.assembly_costs ?? '';
      const asmEmiss = fmtE(asmObj.assembly_emissions);
      const asmNo = asmObj.assembly_no ? `<span class="mono">#${asmObj.assembly_no}</span>` : '';
      tbody.appendChild(
        rowSection(
          `<div style="display:flex;justify-content:space-between;align-items:center;">
             <div><b>${asmName}</b> ${asmNo}</div>
             <div class="muted">Cost: ${asmCost || 'Value Not Calculated or Null'} | Emiss: ${asmEmiss}</div>
           </div>`,
          'assembly'
        )
      );

      // direct parts
      for (const [k, v] of Object.entries(asmObj)) {
        if (v && typeof v === 'object' && v.type === 'part') {
          pushPartBlock(tbody, k, v);
        }
      }

      // sub-assemblies
      for (const [subName, subObj] of Object.entries(asmObj)) {
        if (!(subObj && typeof subObj === 'object' && subObj.type === 'sub_assembly')) continue;

        tbody.appendChild(rowSection(`<b>${asmName}</b> ⇒ ${subName}`, 'subasm'));

        for (const [pname, pobj] of Object.entries(subObj)) {
          if (pobj && typeof pobj === 'object' && pobj.type === 'part') {
            pushPartBlock(tbody, pname, pobj);
          }
        }
      }
    }
  }

  wireRowToggles();
  populateExceptionTagFilter();
}

function pushPartBlock(tbody, partName, partObj) {
  const startIndex = tbody.children.length;

  const ovr = partObj.Subpart_process_overview || {};
  const mass_g = kgToGrams(ovr.mass);
  const q = parseDecimal(partObj.part_quantity) ?? 1;

  const unitPrice = parseDecimal(partObj.part_costs) ?? parseDecimal(partObj.part_costs_sum);
  const unitEmiss = parseDecimal(partObj.part_emissions) ?? parseDecimal(partObj.part_emissions_sum);
  const emissionsHtml = unitEmiss !== null ? qpEmiss(q, unitEmiss) : "Value Not Calculated or Null";

  const costNote = (ovr.material && String(ovr.material).trim() !== '') ? `Cost comment: ${ovr.material}` : '';
  const emissionsNote = firstChildField(partObj, 'comments_emissions')
    ? `Carbon comment: ${firstChildField(partObj, 'comments_emissions')}`
    : '';

  const descTop = (partObj.part_comments || '').trim();
  const mat = materialShort(ovr.material);
  const complexity = parseDecimal(ovr.complexity);
  const procList = Array.isArray(ovr.process) ? ovr.process : [];
  const metaBits = [];
  if (mat) metaBits.push(`<span class="dot">Material: ${mat}</span>`);
  if (complexity !== null) metaBits.push(`<span class="dot">Complexity: ${complexity}</span>`);
  if (procList.length) metaBits.push(`<span class="dot">Process: ${listToChips(procList)}</span>`);
  const descHtml = `${descTop}${metaBits.length ? `<div class="meta">${metaBits.join('')}</div>` : ''}`;

  const partExceptions = toArrayExc(partObj.exception);
  const aggregated = partExceptions.length ? partExceptions : collectChildExceptions(partObj);

  const partRow = rowPart({
    name: partName,
    descHtml,
    mb: partObj.makebuy || '',
    mass_g,
    emissionsHtml,
    emissionsNote,
    quant: q,
    price: unitPrice,
    costNote,
    id: partObj.part_no || '',
    exceptions: aggregated,
    partKey: partName
  });
  tbody.appendChild(partRow);

  // sub-entries
  for (const [key, val] of Object.entries(partObj)) {
    if (!(val && typeof val === 'object' && 'type' in val)) continue;
    const t = val.type;
    const exc = val.exception || [];

    const costNote = val.comments_costs ? `Cost comment: ${val.comments_costs}` : '';
    const emissNote = val.comments_emissions ? `Carbon comment: ${val.comments_emissions}` : '';

    if (t === 'm') {
      tbody.appendChild(
        rowSub('Bought/Material', key,
          val.comments_costs || val.subpart_comments || '',
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          exc,
          costNote, emissNote,
          val.comments_emissions || ''
        )
      );
    } else if (t === 'p') {
      const d = val.subpart_comments || '';
      const emCom = val.comments_emissions || '';
      const meta = emCom ? `<div class="muted">${emCom}</div>` : '';
      tbody.appendChild(
        rowSub('Manufact. Process', key,
          `${d}${meta}`,
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          exc,
          costNote, emissNote
        )
      );
    } else {
      tbody.appendChild(
        rowSub('Subpart', key,
          val.subpart_comments || '',
          val.subpart_quantity, val.subpart_costs, val.subpart_emissions,
          exc,
          costNote, emissNote
        )
      );
    }
  }

  const endIndex = tbody.children.length - 1;
  FLAT_PART_ROWS.push({ startIndex, endIndex, node: partObj, name: partName });
}

function collectChildExceptions(partObj) {
  const ex = [];
  for (const [key, val] of Object.entries(partObj)) {
    if (val && typeof val === 'object' && 'type' in val) {
      const childExc = toArrayExc(val.exception);
      if (childExc.length) ex.push(...childExc);
    }
  }
  const seen = new Set();
  return ex.filter(tag => (seen.has(tag) ? false : (seen.add(tag), true)));
}

/* ===================== Interactions ===================== */
function wireRowToggles() {
  const tbody = document.getElementById('tbody');
  tbody.querySelectorAll('.toggle-part').forEach((btn, i) => {
    btn.addEventListener('click', () => {
      const row = btn.closest('tr');
      const idx = Array.from(tbody.children).indexOf(row);
      const block = FLAT_PART_ROWS.find(b => b.startIndex === idx);
      if (!block) return;
      const { startIndex, endIndex } = block;
      const collapsed = btn.textContent.trim() === '▸';
      btn.textContent = collapsed ? '▾' : '▸';
      for (let j = startIndex + 1; j <= endIndex; j++) {
        tbody.children[j].classList.toggle('hidden');
      }
    });
  });
}
document.getElementById('collapseAll').addEventListener('click', () => {
  const tbody = document.getElementById('tbody');
  tbody.querySelectorAll('.toggle-part').forEach(btn => btn.textContent = '▸');
  FLAT_PART_ROWS.forEach(({startIndex, endIndex}) => {
    for (let j = startIndex + 1; j <= endIndex; j++) tbody.children[j].classList.add('hidden');
  });
});
document.getElementById('expandAll').addEventListener('click', () => {
  const tbody = document.getElementById('tbody');
  tbody.querySelectorAll('.toggle-part').forEach(btn => btn.textContent = '▾');
  FLAT_PART_ROWS.forEach(({startIndex, endIndex}) => {
    for (let j = startIndex + 1; j <= endIndex; j++) tbody.children[j].classList.remove('hidden');
  });
});

/* Legend drawer */
const legendBtn = document.getElementById('legendBtn');
const legend = document.getElementById('legend');
const legendClose = document.getElementById('legendClose');
legendBtn.addEventListener('click', () => { legend.style.display = 'block'; });
legendClose.addEventListener('click', () => { legend.style.display = 'none'; });

function renderLegend() {
  const el = document.getElementById('legendBody');
  const groups = { ok:[], info:[], warn:[], err:[] };
  Object.keys(EXC_META).forEach(tag => {
    groups[EXC_META[tag]].push(tag);
  });
  const block = (title, level) => `
    <h3>${title}</h3>
    <div class="chips" style="margin-bottom:8px;">
      ${groups[level].map(t => `<span class="chip" data-level="${level}">${t}</span>`).join('')}
    </div>
  `;
  el.innerHTML = block('Matches / Success', 'ok') +
                 block('Informational', 'info') +
                 block('Warnings', 'warn') +
                 block('Errors', 'err');
}

/* Search + Filters */
const searchInput = document.getElementById('searchInput');
const makeBuyFilter = document.getElementById('makeBuyFilter');
const exceptionFilter = document.getElementById('exceptionFilter');
const exceptionTagFilter = document.getElementById('exceptionTagFilter');
const onlyWarnErr = document.getElementById('onlyWarnErr');

function populateExceptionTagFilter() {
  const tags = new Set();
  FLAT_PART_ROWS.forEach(({node}) => {
    toArrayExc(node.exception).forEach(t => tags.add(t));
    for (const [k,v] of Object.entries(node)) {
      if (v && typeof v === 'object' && 'type' in v) {
        toArrayExc(v.exception).forEach(t => tags.add(t));
      }
    }
  });
  exceptionTagFilter.innerHTML = '';
  Array.from(tags).sort().forEach(tag => {
    const opt = document.createElement('option');
    opt.value = tag; opt.textContent = tag;
    exceptionTagFilter.appendChild(opt);
  });
}

function selectedExceptionTags() {
  return Array.from(exceptionTagFilter.selectedOptions).map(o => o.value);
}

function applyFilters() {
  const q = (searchInput.value || '').toLowerCase().trim();
  const mb = makeBuyFilter.value;
  const excMode = exceptionFilter.value;
  const excTags = selectedExceptionTags();

  const tbody = document.getElementById('tbody');
  Array.from(tbody.children).forEach(tr => tr.classList.remove('hidden'));

  FLAT_PART_ROWS.forEach(({startIndex, endIndex, node, name}) => {
    let show = true;

    const mbVal = String(node.makebuy || '').toLowerCase();
    if (mb !== 'all' && mbVal !== mb) show = false;

    const hasExc = !!(toArrayExc(node.exception).length || collectChildExceptions(node).length);
    if (excMode === 'only' && !hasExc) show = false;
    if (excMode === 'none' && hasExc) show = false;

    if (show && excTags.length) {
      const nodeTags = new Set([
        ...toArrayExc(node.exception),
        ...collectChildExceptions(node)
      ]);
      const ok = excTags.every(t => nodeTags.has(t));
      if (!ok) show = false;
    }

    if (show && q) {
      const hay = [
        name,
        node.part_no,
        node.part_comments,
        node.Subpart_process_overview?.material,
        ...toArrayExc(node.exception),
        ...collectChildExceptions(node)
      ].filter(Boolean).join(' | ').toLowerCase();
      if (!hay.includes(q)) show = false;
    }

    if (!show) {
      for (let j = startIndex; j <= endIndex; j++) tbody.children[j].classList.add('hidden');
    }
  });

  refreshChips();
}
function refreshChips() {
  const tbody = document.getElementById('tbody');
  FLAT_PART_ROWS.forEach(({startIndex, endIndex, node}) => {
    const partRow = tbody.children[startIndex];
    const partCell = partRow.children[7];
    const partEx = toArrayExc(node.exception).length ? node.exception : collectChildExceptions(node);
    partCell.innerHTML = renderExceptions(partEx);

    for (let j = startIndex + 1; j <= endIndex; j++) {
      const tr = tbody.children[j];
      const lastCell = tr.children[7];
      const titleList = [];
      lastCell.querySelectorAll('.chip').forEach(ch => titleList.push(ch.getAttribute('title') || ch.textContent.trim()));
      const raw = titleList.join(', ');
      lastCell.innerHTML = renderExceptions(raw);
    }
  });
}

/* events */
searchInput.addEventListener('input', debounce(applyFilters, 120));
makeBuyFilter.addEventListener('change', applyFilters);
exceptionFilter.addEventListener('change', applyFilters);
exceptionTagFilter.addEventListener('change', applyFilters);
onlyWarnErr.addEventListener('change', () => {
  ONLY_WARN_ERR = onlyWarnErr.checked;
  refreshChips();
});

/* shortcut to focus search */
window.addEventListener('keydown', (e) => {
  if ((e.metaKey || e.ctrlKey) && e.key === '/') {
    e.preventDefault();
    searchInput.focus();
  }
});

/* debounce */
function debounce(fn, ms) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
}

/* ===================== Load + Init with plain→encrypted fallback ===================== */
const PLAIN_JSON = "DUT25_Prelim_BOM_with_subparts.json";
const ENCRYPTED_JSON = "DUT25_Prelim_BOM_with_subparts_encrypted.json";
const PBKDF2_ITERS = 390000; // must match Python
const SALT_LEN = 16;
const IV_LEN = 12;
const TAG_LEN = 16;

async function tryLoadPlain(path) {
  try {
    const res = await fetch(path, { cache: 'no-store' });
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    return null;
  }
}

async function loadEncrypted(path) {
  const res = await fetch(path, { cache: 'no-store' });
  if (!res.ok) throw new Error(`Encrypted JSON not found (${res.status})`);
  const buf = await res.arrayBuffer();
  if (buf.byteLength < SALT_LEN + IV_LEN + TAG_LEN + 1) {
    throw new Error("Encrypted blob too small");
  }

  const salt = buf.slice(0, SALT_LEN);
  const iv   = buf.slice(SALT_LEN, SALT_LEN + IV_LEN);
  const tag  = buf.slice(buf.byteLength - TAG_LEN);
  const ct   = buf.slice(SALT_LEN + IV_LEN, buf.byteLength - TAG_LEN);

  const pwd = prompt("🔒 Enter password to unlock BOM:");
  if (!pwd) throw new Error("No password entered");

  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pwd), { name: "PBKDF2" }, false, ["deriveKey"]);
  const key = await crypto.subtle.deriveKey(
    { name: "PBKDF2", salt: salt, iterations: PBKDF2_ITERS, hash: "SHA-256" },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    false,
    ["decrypt"]
  );

  // browser decrypt expects ciphertext||tag as a single buffer
  const full = new Uint8Array(ct.byteLength + tag.byteLength);
  full.set(new Uint8Array(ct), 0);
  full.set(new Uint8Array(tag), new Uint8Array(ct).length);

  try {
    const plain = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, full);
    return JSON.parse(new TextDecoder().decode(plain));
  } catch (e) {
    throw new Error("Decryption failed (wrong password or corrupted file).");
  }
}

async function loadAndRender(path) {
  const fileLabel = document.getElementById('fileLabel');
  const lockBadge = document.getElementById('lockBadge');

  fileLabel.textContent = path;

  // 1) Try plain first (dev/local use)
  let bom = await tryLoadPlain(path);
  if (bom) {
    lockBadge.textContent = "mode: plain";
    renderBOM(bom);
    renderLegend();
    applyFilters();
    return;
  }

  // 2) Fall back to encrypted (public / GitHub Pages)
  try {
    bom = await loadEncrypted(ENCRYPTED_JSON);
    lockBadge.textContent = "mode: encrypted";
    fileLabel.textContent = ENCRYPTED_JSON;
    renderBOM(bom);
    renderLegend();
    applyFilters();
  } catch (err) {
    console.warn(err);
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = `<tr><td colspan="8" class="muted">Could not load BOM. ${err.message}</td></tr>`;
  }
}

document.getElementById('loadBtn').addEventListener('click', () => {
  const p = document.getElementById('jsonPath').value.trim() || PLAIN_JSON;
  loadAndRender(p).catch(err => alert(err.message));
});
document.getElementById('reloadBtn').addEventListener('click', () => {
  const p = document.getElementById('jsonPath').value.trim() || PLAIN_JSON;
  loadAndRender(p).catch(err => alert(err.message));
});

// Auto-load default on open
loadAndRender(document.getElementById('jsonPath').value).catch(err => {
  console.warn(err);
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = `<tr><td colspan="8" class="muted">Could not load JSON. Check files and serve via a local web server.</td></tr>`;
});
</script>
</body>
</html>
